import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { useEffect, useMemo, useState } from 'react';
import { api } from '../services/api';
import { useSettings } from '../context/SettingsContext';
import { exportPacketsToCsv, exportTestToJson } from '../utils/exporters';
const HistoryPage = () => {
    const { settings } = useSettings();
    const [tests, setTests] = useState([]);
    const [modeFilter, setModeFilter] = useState('ALL');
    const [networkFilter, setNetworkFilter] = useState('ALL');
    const [selectedTest, setSelectedTest] = useState(null);
    useEffect(() => {
        api.listTests(settings).then(setTests);
    }, [settings]);
    const filteredTests = useMemo(() => {
        return tests.filter((test) => {
            const modeMatches = modeFilter === 'ALL' || test.mode === modeFilter;
            const networkMatches = networkFilter === 'ALL' || test.networkType === networkFilter;
            return modeMatches && networkMatches;
        });
    }, [tests, modeFilter, networkFilter]);
    const openDetail = async (id) => {
        const detail = await api.getTestDetail(settings, id);
        setSelectedTest(detail);
    };
    const buildInterpretation = (test) => {
        const jitterLabel = test.jitter < 10 ? 'baja' : test.jitter < 25 ? 'moderada' : 'alta';
        const notes = test.interpretationNotes && test.interpretationNotes.trim().length ? test.interpretationNotes : '';
        return [
            `Se registró una fuerza de señal de ${test.signalStrength} usando ${test.internetDirection} en ${test.bandFrequency}.`,
            `La distancia reportada fue ${test.distanceDescription} y el plan contratado ${test.plan} (${test.signalSource}).`,
            `El RTT promedio fue ${test.avgLatency.toFixed(2)} ms con variación ${jitterLabel} (${test.jitter.toFixed(2)} ms) y pérdida ${test.packetLoss.toFixed(2)}%.`,
            test.speedtest
                ? `Speedtest Ookla: ${test.speedtest.download.toFixed(2)} Mbps ↓ / ${test.speedtest.upload.toFixed(2)} Mbps ↑ (ping ${test.speedtest.ping.toFixed(1)} ms).`
                : 'No se registró Speedtest en esta ejecución.',
            notes ? `Notas: ${notes}` : ''
        ]
            .filter(Boolean)
            .join(' ');
    };
    return (_jsxs("div", { className: "space-y-6", children: [_jsxs("div", { children: [_jsx("h1", { className: "text-3xl font-semibold", children: "Historial" }), _jsx("p", { className: "text-sm text-slate-400", children: "Consulta todas las pruebas hechas en el semestre." })] }), _jsxs("div", { className: "flex flex-wrap gap-4 rounded-2xl border border-slate-800 bg-slate-900/60 p-4", children: [_jsxs("label", { className: "text-sm text-slate-400", children: ["Modo", _jsxs("select", { className: "mt-2 rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-white", value: modeFilter, onChange: (event) => setModeFilter(event.target.value), children: [_jsx("option", { value: "ALL", children: "Todos" }), _jsx("option", { value: "LAN", children: "LAN" }), _jsx("option", { value: "REMOTE", children: "Remotas" })] })] }), _jsxs("label", { className: "text-sm text-slate-400", children: ["Tipo de red", _jsxs("select", { className: "mt-2 rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-white", value: networkFilter, onChange: (event) => setNetworkFilter(event.target.value), children: [_jsx("option", { value: "ALL", children: "Todos" }), [...new Set(tests.map((test) => test.networkType))].map((network) => (_jsx("option", { value: network, children: network }, network)))] })] })] }), _jsx("div", { className: "overflow-x-auto rounded-2xl border border-slate-800", children: _jsxs("table", { className: "min-w-full divide-y divide-slate-800 text-sm", children: [_jsx("thead", { className: "bg-slate-900 text-slate-400", children: _jsxs("tr", { children: [_jsx("th", { className: "px-4 py-2 text-left", children: "Nombre" }), _jsx("th", { className: "px-4 py-2 text-left", children: "Fecha" }), _jsx("th", { className: "px-4 py-2 text-left", children: "Modo" }), _jsx("th", { className: "px-4 py-2 text-left", children: "Tipo de red" }), _jsx("th", { className: "px-4 py-2 text-left", children: "Latencia promedio" }), _jsx("th", { className: "px-4 py-2 text-left", children: "P\u00E9rdida" }), _jsx("th", { className: "px-4 py-2 text-left", children: "Acciones" })] }) }), _jsx("tbody", { className: "divide-y divide-slate-800 bg-slate-900/40 text-slate-300", children: filteredTests.map((test) => (_jsxs("tr", { children: [_jsx("td", { className: "px-4 py-3 font-semibold text-white", children: test.name }), _jsx("td", { className: "px-4 py-3", children: new Date(test.createdAt).toLocaleString() }), _jsx("td", { className: "px-4 py-3", children: test.mode }), _jsx("td", { className: "px-4 py-3", children: test.networkType }), _jsxs("td", { className: "px-4 py-3", children: [test.avgLatency?.toFixed(2), " ms"] }), _jsxs("td", { className: "px-4 py-3", children: [test.packetLoss?.toFixed(2), "%"] }), _jsx("td", { className: "px-4 py-3", children: _jsx("button", { className: "text-sky-400 hover:underline", onClick: () => openDetail(test.id), children: "Ver detalle" }) })] }, test.id))) })] }) }), selectedTest && (_jsxs("div", { className: "rounded-2xl border border-slate-800 bg-slate-900/60 p-6", children: [_jsxs("div", { className: "flex items-center justify-between", children: [_jsxs("div", { children: [_jsx("p", { className: "text-xl font-semibold", children: selectedTest.name }), _jsxs("p", { className: "text-sm text-slate-400", children: [selectedTest.location, " \u2013 ", selectedTest.networkType] })] }), _jsxs("div", { className: "flex gap-2 text-xs", children: [_jsx("button", { className: "rounded-lg border border-slate-700 px-3 py-1", onClick: () => exportPacketsToCsv(selectedTest), children: "Exportar CSV" }), _jsx("button", { className: "rounded-lg border border-slate-700 px-3 py-1", onClick: () => exportTestToJson(selectedTest), children: "Exportar JSON" })] })] }), _jsxs("div", { className: "mt-4 grid gap-4 md:grid-cols-3 text-sm", children: [_jsxs("p", { children: ["Latencia promedio: ", selectedTest.avgLatency.toFixed(2), " ms"] }), _jsxs("p", { children: ["Throughput: ", selectedTest.throughput.toFixed(2), " Mbps"] }), _jsxs("p", { children: ["P\u00E9rdida: ", selectedTest.packetLoss.toFixed(2), " %"] }), _jsxs("p", { children: ["RTT min: ", selectedTest.minLatency.toFixed(2), " ms"] }), _jsxs("p", { children: ["RTT max: ", selectedTest.maxLatency.toFixed(2), " ms"] }), _jsxs("p", { children: ["Jitter: ", selectedTest.jitter.toFixed(2), " ms"] })] }), _jsxs("div", { className: "mt-4 grid gap-3 text-xs text-slate-400 md:grid-cols-3", children: [_jsxs("p", { children: ["Fuerza de se\u00F1al: ", selectedTest.signalStrength] }), _jsxs("p", { children: ["Banda / frecuencia: ", selectedTest.bandFrequency] }), _jsxs("p", { children: ["Medio de Internet: ", selectedTest.internetDirection] }), _jsxs("p", { children: ["Distancia: ", selectedTest.distanceDescription] }), _jsxs("p", { children: ["Plan contratado: ", selectedTest.plan] }), _jsxs("p", { children: ["Se\u00F1al de procedencia: ", selectedTest.signalSource] })] }), selectedTest.speedtest && (_jsxs("div", { className: "mt-4 rounded-lg border border-slate-800/60 bg-slate-950/50 p-4 text-xs text-slate-300", children: [_jsx("p", { className: "text-sm font-semibold text-white", children: "Speedtest adjunto" }), _jsxs("div", { className: "mt-2 grid gap-2 md:grid-cols-4", children: [_jsxs("p", { children: ["Ping: ", selectedTest.speedtest.ping.toFixed(2), " ms"] }), _jsxs("p", { children: ["Download: ", selectedTest.speedtest.download.toFixed(2), " Mbps"] }), _jsxs("p", { children: ["Upload: ", selectedTest.speedtest.upload.toFixed(2), " Mbps"] }), _jsxs("p", { children: ["Servidor: ", selectedTest.speedtest.server] }), _jsxs("p", { children: ["ISP: ", selectedTest.speedtest.isp] }), _jsxs("p", { className: "md:col-span-2", children: ["Fecha medici\u00F3n: ", new Date(selectedTest.speedtest.timestamp).toLocaleString()] })] })] })), _jsxs("div", { className: "mt-4 rounded-lg bg-slate-950/60 p-4 text-xs text-slate-400", children: [_jsxs("p", { children: ["Total paquetes: ", selectedTest.packetCount] }), _jsxs("p", { children: ["Enviados: ", selectedTest.packetCount] }), _jsxs("p", { children: ["Recibidos: ", selectedTest.packets.filter((p) => p.status === 'received').length] }), _jsxs("p", { children: ["Perdidos: ", selectedTest.packets.filter((p) => p.status === 'lost').length] })] }), _jsxs("div", { className: "mt-4 rounded-lg border border-slate-800/60 bg-slate-950/60 p-4 text-xs text-slate-300", children: [_jsx("p", { className: "text-sm font-semibold text-white", children: "Interpretaci\u00F3n t\u00E9cnica" }), _jsx("p", { className: "mt-2 leading-6", children: buildInterpretation(selectedTest) })] })] }))] }));
};
export default HistoryPage;
